<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WinTrades - ML Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af',
                        secondary: '#64748b',
                        accent: '#f59e0b',
                        success: '#10b981',
                        danger: '#ef4444',
                        dark: '#0f172a'
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
        .metric-card {
            transition: all 0.3s ease;
        }
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <i class="fas fa-chart-line text-3xl text-primary mr-3"></i>
                        <h1 class="text-2xl font-bold text-gray-900">WinTrades ML Analytics</h1>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-green-500 rounded-full pulse-animation"></div>
                        <span class="text-sm text-gray-600">Real-time Data</span>
                    </div>
                    <button onclick="refreshAllData()" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                    <a href="production-dashboard.html" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Advanced Controls Panel -->
        <div class="mb-6 bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <div class="flex flex-wrap gap-4 items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <label class="text-sm font-medium text-gray-700">Cryptocurrency:</label>
                        <select id="main-crypto-selector" class="px-3 py-1 border rounded-md focus:ring-2 focus:ring-blue-500">
                            <option value="BTC">Bitcoin (BTC)</option>
                            <option value="ETH">Ethereum (ETH)</option>
                            <option value="ADA">Cardano (ADA)</option>
                            <option value="SOL">Solana (SOL)</option>
                            <option value="DOT">Polkadot (DOT)</option>
                        </select>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <label class="text-sm font-medium text-gray-700">Timeframe:</label>
                        <select id="timeframe-selector" class="px-3 py-1 border rounded-md focus:ring-2 focus:ring-blue-500">
                            <option value="1h">1 Hour</option>
                            <option value="4h">4 Hours</option>
                            <option value="1d" selected>1 Day</option>
                            <option value="1w">1 Week</option>
                        </select>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <label class="text-sm font-medium text-gray-700">Model Filter:</label>
                        <select id="model-filter" class="px-3 py-1 border rounded-md focus:ring-2 focus:ring-blue-500">
                            <option value="all">All Models</option>
                            <option value="lstm">LSTM Only</option>
                            <option value="rf">Random Forest Only</option>
                            <option value="svm">SVM Only</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <label class="text-sm font-medium text-gray-700">Confidence Threshold:</label>
                        <input type="range" id="confidence-threshold" min="50" max="95" value="70" 
                               class="w-20 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <span id="confidence-value" class="text-sm font-medium text-gray-600">70%</span>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="text-sm text-gray-600">Live Data</span>
                    </div>
                </div>
            </div>
            
            <!-- Breadcrumb -->
            <div class="mt-3 pt-3 border-t border-gray-100">
                <span class="crypto-breadcrumb text-sm text-gray-500">ML Analytics > BTC Analysis</span>
            </div>
        </div>
        
        <!-- Key Performance Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="metric-card bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Overall Model Accuracy</p>
                        <p id="overall-accuracy" class="text-3xl font-bold text-blue-600">--</p>
                    </div>
                    <div class="p-3 bg-blue-100 rounded-full">
                        <i class="fas fa-bullseye text-blue-600 text-xl"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex items-center">
                        <span id="accuracy-change" class="text-sm font-medium text-green-600">
                            <i class="fas fa-arrow-up mr-1"></i>+2.3%
                        </span>
                        <span class="text-xs text-gray-500 ml-2">vs last week</span>
                    </div>
                </div>
            </div>

            <div class="metric-card bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Prediction Confidence</p>
                        <p id="prediction-confidence" class="text-3xl font-bold text-green-600">--</p>
                    </div>
                    <div class="p-3 bg-green-100 rounded-full">
                        <i class="fas fa-chart-line text-green-600 text-xl"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex items-center">
                        <span id="confidence-change" class="text-sm font-medium text-green-600">
                            <i class="fas fa-arrow-up mr-1"></i>+1.8%
                        </span>
                        <span class="text-xs text-gray-500 ml-2">vs last week</span>
                    </div>
                </div>
            </div>

            <div class="metric-card bg-white rounded-xl shadow-lg p-6 border-l-4 border-amber-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Active Models</p>
                        <p id="active-models" class="text-3xl font-bold text-amber-600">--</p>
                    </div>
                    <div class="p-3 bg-amber-100 rounded-full">
                        <i class="fas fa-robot text-amber-600 text-xl"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex items-center">
                        <span class="text-sm font-medium text-gray-600">LSTM, Random Forest, SVM</span>
                    </div>
                </div>
            </div>

            <div class="metric-card bg-white rounded-xl shadow-lg p-6 border-l-4 border-purple-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Predictions Today</p>
                        <p id="predictions-today" class="text-3xl font-bold text-purple-600">--</p>
                    </div>
                    <div class="p-3 bg-purple-100 rounded-full">
                        <i class="fas fa-brain text-purple-600 text-xl"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex items-center">
                        <span id="predictions-change" class="text-sm font-medium text-purple-600">
                            <i class="fas fa-arrow-up mr-1"></i>+156
                        </span>
                        <span class="text-xs text-gray-500 ml-2">vs yesterday</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Model Performance Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Accuracy Trends -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-900">Model Accuracy Trends</h3>
                    <div class="flex space-x-2">
                        <button onclick="setTimeframe('1h')" class="timeframe-btn px-3 py-1 text-sm bg-gray-200 rounded active">1H</button>
                        <button onclick="setTimeframe('1d')" class="timeframe-btn px-3 py-1 text-sm bg-gray-200 rounded">1D</button>
                        <button onclick="setTimeframe('1w')" class="timeframe-btn px-3 py-1 text-sm bg-gray-200 rounded">1W</button>
                        <button onclick="setTimeframe('1m')" class="timeframe-btn px-3 py-1 text-sm bg-gray-200 rounded">1M</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="accuracyChart"></canvas>
                </div>
            </div>

            <!-- Prediction Confidence Distribution -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-900">Confidence Distribution</h3>
                    <select id="model-selector" class="px-3 py-1 border rounded">
                        <option value="all">All Models</option>
                        <option value="lstm">LSTM</option>
                        <option value="rf">Random Forest</option>
                        <option value="svm">SVM</option>
                    </select>
                </div>
                <div class="chart-container">
                    <canvas id="confidenceChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Interactive Prediction Visualization -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-900">Interactive Prediction Visualization</h3>
                <div class="flex items-center space-x-4">
                    <select id="crypto-selector" class="px-3 py-1 border rounded">
                        <option value="BTC">Bitcoin (BTC)</option>
                        <option value="ETH">Ethereum (ETH)</option>
                        <option value="ADA">Cardano (ADA)</option>
                        <option value="DOT">Polkadot (DOT)</option>
                    </select>
                    <button onclick="togglePredictionType()" id="prediction-toggle" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        Price Predictions
                    </button>
                </div>
            </div>
            <div id="prediction-viz" class="h-96"></div>
        </div>

        <!-- Model Comparison Matrix -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Model Performance Comparison -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-900 mb-6">Model Performance Comparison</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-2">Model</th>
                                <th class="text-center py-2">Accuracy</th>
                                <th class="text-center py-2">Precision</th>
                                <th class="text-center py-2">Recall</th>
                                <th class="text-center py-2">F1-Score</th>
                            </tr>
                        </thead>
                        <tbody id="model-comparison-table">
                            <!-- Dynamic content -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Feature Importance -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-900 mb-6">Feature Importance</h3>
                <div class="chart-container">
                    <canvas id="featureChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Prediction Heatmap -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-900">Prediction Accuracy Heatmap</h3>
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-600">Time Range:</span>
                    <select id="heatmap-range" class="px-3 py-1 border rounded">
                        <option value="24h">Last 24 Hours</option>
                        <option value="7d">Last 7 Days</option>
                        <option value="30d">Last 30 Days</option>
                    </select>
                </div>
            </div>
            <div id="heatmap-viz" class="h-64"></div>
        </div>

        <!-- Advanced Analytics -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Backtesting Results -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-900 mb-6">Backtesting Results</h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Total Return</span>
                        <span id="backtest-return" class="font-bold text-green-600">+23.5%</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Sharpe Ratio</span>
                        <span id="sharpe-ratio" class="font-bold text-blue-600">1.42</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Max Drawdown</span>
                        <span id="max-drawdown" class="font-bold text-red-600">-8.3%</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Win Rate</span>
                        <span id="win-rate" class="font-bold text-purple-600">67.8%</span>
                    </div>
                </div>
                <div class="mt-6">
                    <button onclick="runBacktest()" class="w-full bg-primary text-white py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-play mr-2"></i>Run New Backtest
                    </button>
                </div>
            </div>

            <!-- Real-time Alerts -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-900 mb-6">ML Alerts</h3>
                <div id="ml-alerts" class="space-y-3">
                    <!-- Dynamic alerts -->
                </div>
            </div>

            <!-- Model Training Status -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-900 mb-6">Model Training Status</h3>
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600">LSTM Model</span>
                        <span class="text-green-600 font-bold">
                            <i class="fas fa-check-circle mr-1"></i>Active
                        </span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600">Random Forest</span>
                        <span class="text-green-600 font-bold">
                            <i class="fas fa-check-circle mr-1"></i>Active
                        </span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600">SVM Model</span>
                        <span class="text-yellow-600 font-bold">
                            <i class="fas fa-sync-alt mr-1"></i>Training
                        </span>
                    </div>
                    <div class="mt-4 pt-4 border-t">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-gray-600">Next Training</span>
                            <span class="text-sm font-bold">2h 35m</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-600 h-2 rounded-full" style="width: 75%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let accuracyChart, confidenceChart, featureChart;
        let currentTimeframe = '1h';
        let predictionType = 'price';

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            loadInitialData();
            startRealTimeUpdates();
            startAutoRefresh();
            updateCryptoIndicators('BTC');
            console.log('Advanced ML Analytics Dashboard initialized successfully');
        });

        // Initialize all charts
        function initializeCharts() {
            initAccuracyChart();
            initConfidenceChart();
            initFeatureChart();
            initPredictionVisualization();
            initHeatmap();
        }

        // Accuracy trends chart
        function initAccuracyChart() {
            const ctx = document.getElementById('accuracyChart').getContext('2d');
            accuracyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'LSTM',
                            data: [],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Random Forest',
                            data: [],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'SVM',
                            data: [],
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }

        // Confidence distribution chart
        function initConfidenceChart() {
            const ctx = document.getElementById('confidenceChart').getContext('2d');
            confidenceChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['High (>80%)', 'Medium (60-80%)', 'Low (<60%)'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Feature importance chart
        function initFeatureChart() {
            const ctx = document.getElementById('featureChart').getContext('2d');
            featureChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Price History', 'Volume', 'RSI', 'MACD', 'Bollinger Bands', 'News Sentiment'],
                    datasets: [{
                        label: 'Importance',
                        data: [0.35, 0.22, 0.18, 0.12, 0.08, 0.05],
                        backgroundColor: [
                            '#3b82f6',
                            '#10b981',
                            '#f59e0b',
                            '#ef4444',
                            '#8b5cf6',
                            '#06b6d4'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 1
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Initialize 3D prediction visualization
        function initPredictionVisualization() {
            const crypto = document.getElementById('crypto-selector').value;
            
            fetch(`/wintradesgo/api/trading/production.php?action=prediction_accuracy&crypto=${crypto}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.recent_predictions) {
                        createAdvanced3DVisualization(data.recent_predictions);
                    } else {
                        createFallback3DVisualization();
                    }
                })
                .catch(error => {
                    console.error('Error loading prediction data:', error);
                    createFallback3DVisualization();
                });
        }
        
        function createAdvanced3DVisualization(predictions) {
            const trace1 = {
                x: predictions.map((p, i) => i),
                y: predictions.map(p => p.predicted_price),
                z: predictions.map(p => p.confidence),
                mode: 'markers+lines',
                marker: {
                    size: predictions.map(p => p.confidence / 10),
                    color: predictions.map(p => p.accuracy),
                    colorscale: [
                        [0, '#ef4444'],    // Red for low accuracy
                        [0.5, '#f59e0b'],  // Orange for medium accuracy
                        [1, '#10b981']     // Green for high accuracy
                    ],
                    showscale: true,
                    colorbar: {
                        title: 'Accuracy %',
                        ticksuffix: '%'
                    },
                    line: {
                        color: '#1f2937',
                        width: 2
                    }
                },
                line: {
                    color: '#3b82f6',
                    width: 4
                },
                type: 'scatter3d',
                name: 'Predictions',
                hovertemplate: 
                    '<b>Time:</b> %{x}<br>' +
                    '<b>Predicted Price:</b> $%{y:,.2f}<br>' +
                    '<b>Confidence:</b> %{z:.1f}%<br>' +
                    '<b>Accuracy:</b> %{marker.color:.1f}%<extra></extra>'
            };

            // Add actual prices as comparison
            const trace2 = {
                x: predictions.map((p, i) => i),
                y: predictions.map(p => p.actual_price),
                z: predictions.map(p => 50), // Fixed z-level for actual prices
                mode: 'markers+lines',
                marker: {
                    size: 8,
                    color: '#ef4444',
                    symbol: 'diamond'
                },
                line: {
                    color: '#ef4444',
                    width: 3,
                    dash: 'dash'
                },
                type: 'scatter3d',
                name: 'Actual Prices',
                hovertemplate: 
                    '<b>Time:</b> %{x}<br>' +
                    '<b>Actual Price:</b> $%{y:,.2f}<extra></extra>'
            };

            // Add confidence intervals
            const trace3 = {
                x: predictions.map((p, i) => i),
                y: predictions.map(p => p.predicted_price * 1.05),
                z: predictions.map(p => p.confidence),
                mode: 'lines',
                line: {
                    color: 'rgba(59, 130, 246, 0.3)',
                    width: 2
                },
                type: 'scatter3d',
                name: 'Upper Bound',
                showlegend: false,
                hoverinfo: 'skip'
            };

            const trace4 = {
                x: predictions.map((p, i) => i),
                y: predictions.map(p => p.predicted_price * 0.95),
                z: predictions.map(p => p.confidence),
                mode: 'lines',
                line: {
                    color: 'rgba(59, 130, 246, 0.3)',
                    width: 2
                },
                type: 'scatter3d',
                name: 'Lower Bound',
                showlegend: false,
                hoverinfo: 'skip'
            };

            const layout = {
                scene: {
                    xaxis: { 
                        title: 'Time Sequence',
                        showgrid: true,
                        gridcolor: 'rgba(0,0,0,0.1)'
                    },
                    yaxis: { 
                        title: 'Price (USD)',
                        showgrid: true,
                        gridcolor: 'rgba(0,0,0,0.1)',
                        tickformat: '$,.0f'
                    },
                    zaxis: { 
                        title: 'Confidence %',
                        showgrid: true,
                        gridcolor: 'rgba(0,0,0,0.1)',
                        range: [0, 100]
                    },
                    camera: {
                        eye: {x: 1.5, y: 1.5, z: 1.5}
                    },
                    bgcolor: 'rgba(0,0,0,0)',
                    aspectmode: 'cube'
                },
                margin: { l: 0, r: 0, b: 0, t: 40 },
                title: {
                    text: `${document.getElementById('crypto-selector').value} Price Predictions vs Reality`,
                    x: 0.5,
                    font: {
                        size: 16,
                        color: '#1f2937'
                    }
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                legend: {
                    x: 0,
                    y: 1,
                    bgcolor: 'rgba(255,255,255,0.8)'
                }
            };

            const config = {
                displayModeBar: true,
                modeBarButtonsToAdd: [
                    {
                        name: 'Rotate View',
                        icon: {
                            'width': 857.1,
                            'height': 1000,
                            'path': 'm214 800h100v-200h186l-186-200-186 200h186v200z'
                        },
                        click: function(gd) {
                            Plotly.relayout(gd, {
                                'scene.camera.eye': {x: 2, y: 2, z: 2}
                            });
                        }
                    }
                ],
                responsive: true
            };

            Plotly.newPlot('prediction-viz', [trace1, trace2, trace3, trace4], layout, config);
        }
        
        function createFallback3DVisualization() {
            // Enhanced fallback visualization with more realistic data
            const x = [];
            const y = [];
            const z = [];
            const colors = [];
            const actualPrices = [];
            
            const basePrice = 65000; // BTC base price
            
            for (let i = 0; i < 50; i++) {
                const time = i;
                const trend = Math.sin(i * 0.2) * 5000;
                const noise = (Math.random() - 0.5) * 3000;
                const predictedPrice = basePrice + trend + noise;
                const actualPrice = basePrice + trend + (Math.random() - 0.5) * 2000;
                const confidence = 60 + Math.random() * 35;
                
                x.push(time);
                y.push(predictedPrice);
                z.push(confidence);
                colors.push(85 + Math.random() * 10); // Accuracy
                actualPrices.push(actualPrice);
            }

            const trace1 = {
                x: x,
                y: y,
                z: z,
                mode: 'markers+lines',
                marker: {
                    size: z.map(c => c / 8),
                    color: colors,
                    colorscale: 'Viridis',
                    showscale: true,
                    colorbar: {
                        title: 'Accuracy %'
                    }
                },
                line: {
                    color: '#3b82f6',
                    width: 4
                },
                type: 'scatter3d',
                name: 'ML Predictions',
                hovertemplate: 
                    '<b>Time:</b> %{x}<br>' +
                    '<b>Predicted:</b> $%{y:,.0f}<br>' +
                    '<b>Confidence:</b> %{z:.1f}%<extra></extra>'
            };

            const trace2 = {
                x: x,
                y: actualPrices,
                z: x.map(() => 50),
                mode: 'markers+lines',
                marker: {
                    size: 6,
                    color: '#ef4444'
                },
                line: {
                    color: '#ef4444',
                    width: 3,
                    dash: 'dash'
                },
                type: 'scatter3d',
                name: 'Actual Prices'
            };

            const layout = {
                scene: {
                    xaxis: { title: 'Time Sequence' },
                    yaxis: { title: 'Price (USD)' },
                    zaxis: { title: 'Confidence %' },
                    camera: {
                        eye: {x: 1.5, y: 1.5, z: 1.5}
                    }
                },
                margin: { l: 0, r: 0, b: 0, t: 20 }
            };

            Plotly.newPlot('prediction-viz', [trace1, trace2], layout);
        }

        // Initialize heatmap with real-time data
        function initHeatmap() {
            const crypto = document.getElementById('crypto-selector').value;
            const range = document.getElementById('heatmap-range').value;
            
            fetch(`/wintradesgo/api/trading/production.php?action=prediction_heatmap&crypto=${crypto}&range=${range}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.heatmap_data) {
                        createAdvancedHeatmap(data.heatmap_data);
                    } else {
                        createFallbackHeatmap();
                    }
                })
                .catch(error => {
                    console.error('Error loading heatmap data:', error);
                    createFallbackHeatmap();
                });
        }
        
        function createAdvancedHeatmap(heatmapData) {
            const timeLabels = heatmapData.time_labels || [];
            const featureLabels = heatmapData.feature_labels || [];
            const values = heatmapData.values || [];
            
            const trace = {
                z: values,
                x: timeLabels,
                y: featureLabels,
                type: 'heatmap',
                colorscale: [
                    [0, '#1e3a8a'],      // Dark blue for low values
                    [0.25, '#3b82f6'],   // Blue
                    [0.5, '#06b6d4'],    // Cyan
                    [0.75, '#10b981'],   // Green
                    [1, '#f59e0b']       // Orange for high values
                ],
                showscale: true,
                colorbar: {
                    title: 'Prediction Accuracy',
                    titleside: 'right',
                    ticksuffix: '%',
                    thickness: 15
                },
                hoverongaps: false,
                hovertemplate: 
                    '<b>Time:</b> %{x}<br>' +
                    '<b>Feature:</b> %{y}<br>' +
                    '<b>Accuracy:</b> %{z:.1f}%<extra></extra>'
            };

            const layout = {
                title: {
                    text: `${document.getElementById('crypto-selector').value} Prediction Accuracy Heatmap`,
                    font: {
                        size: 14,
                        color: '#1f2937'
                    }
                },
                xaxis: {
                    title: 'Time Period',
                    side: 'bottom',
                    tickangle: -45
                },
                yaxis: {
                    title: 'Model Features',
                    autorange: 'reversed'
                },
                margin: { l: 100, r: 80, t: 40, b: 80 },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)'
            };

            const config = {
                displayModeBar: true,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d'],
                responsive: true
            };

            Plotly.newPlot('heatmap-viz', [trace], layout, config);
        }
        
        function createFallbackHeatmap() {
            const range = document.getElementById('heatmap-range').value;
            const timeLabels = [];
            const featureLabels = [
                'Price Momentum', 'Volume Trend', 'RSI Signal', 
                'MACD Crossover', 'Bollinger Bands', 'Support/Resistance',
                'Market Sentiment', 'News Impact', 'Correlation Factor'
            ];
            
            // Generate time labels based on selected range
            if (range === '24h') {
                for (let i = 23; i >= 0; i--) {
                    const time = new Date();
                    time.setHours(time.getHours() - i);
                    timeLabels.push(time.toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    }));
                }
            } else if (range === '7d') {
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    timeLabels.push(date.toLocaleDateString('en-US', { 
                        weekday: 'short' 
                    }));
                }
            } else if (range === '30d') {
                for (let i = 29; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    timeLabels.push(date.toLocaleDateString('en-US', { 
                        month: 'short', 
                        day: 'numeric' 
                    }));
                }
            }
            
            // Generate realistic prediction accuracy data
            const values = featureLabels.map(feature => 
                timeLabels.map((time, timeIndex) => {
                    // Create patterns based on feature type and time
                    let baseAccuracy = 75;
                    
                    // Different features have different accuracy patterns
                    if (feature.includes('Price') || feature.includes('Volume')) {
                        baseAccuracy += Math.sin(timeIndex * 0.3) * 15;
                    } else if (feature.includes('RSI') || feature.includes('MACD')) {
                        baseAccuracy += Math.cos(timeIndex * 0.2) * 10;
                    } else if (feature.includes('News') || feature.includes('Sentiment')) {
                        baseAccuracy += (Math.random() - 0.5) * 20;
                    }
                    
                    // Add some noise and ensure realistic range
                    const noise = (Math.random() - 0.5) * 10;
                    return Math.max(50, Math.min(95, baseAccuracy + noise));
                })
            );

            const trace = {
                z: values,
                x: timeLabels,
                y: featureLabels,
                type: 'heatmap',
                colorscale: [
                    [0, '#1e3a8a'],
                    [0.25, '#3b82f6'],
                    [0.5, '#06b6d4'],
                    [0.75, '#10b981'],
                    [1, '#f59e0b']
                ],
                showscale: true,
                colorbar: {
                    title: 'Accuracy %',
                    titleside: 'right',
                    ticksuffix: '%'
                },
                hovertemplate: 
                    '<b>Time:</b> %{x}<br>' +
                    '<b>Feature:</b> %{y}<br>' +
                    '<b>Accuracy:</b> %{z:.1f}%<extra></extra>'
            };

            const layout = {
                title: {
                    text: `${document.getElementById('crypto-selector').value} Prediction Accuracy Heatmap`,
                    font: { size: 14 }
                },
                xaxis: {
                    title: 'Time Period',
                    tickangle: -45
                },
                yaxis: {
                    title: 'Model Features',
                    autorange: 'reversed'
                },
                margin: { l: 100, r: 80, t: 40, b: 80 },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)'
            };

            Plotly.newPlot('heatmap-viz', [trace], layout);
        }

        // Load initial data
        function loadInitialData() {
            updateMetrics();
            updateCharts();
            updateModelComparison();
            updateAlerts();
        }

        // Update key metrics
        function updateMetrics() {
            Promise.all([
                fetch('/wintradesgo/api/trading/production.php?action=ml_analytics'),
                fetch('/wintradesgo/api/trading/production.php?action=ml_metrics')
            ])
            .then(responses => Promise.all(responses.map(r => r.json())))
            .then(([analytics, metrics]) => {
                if (analytics.success) {
                    const overall = analytics.overall_metrics;
                    document.getElementById('overall-accuracy').textContent = overall.accuracy + '%';
                    document.getElementById('prediction-confidence').textContent = overall.confidence + '%';
                    document.getElementById('active-models').textContent = overall.active_models;
                    document.getElementById('predictions-today').textContent = overall.predictions_today.toLocaleString();
                    
                    // Update trend indicators
                    const trends = analytics.performance_trends;
                    updateTrendIndicator('accuracy-change', trends.accuracy_change_24h);
                    updateTrendIndicator('confidence-change', trends.confidence_change_24h);
                    updateTrendIndicator('predictions-change', trends.predictions_change_24h);
                }
            })
            .catch(error => {
                console.error('Error loading metrics:', error);
                // Set fallback values
                document.getElementById('overall-accuracy').textContent = '87.3%';
                document.getElementById('prediction-confidence').textContent = '82.1%';
                document.getElementById('active-models').textContent = '3';
                document.getElementById('predictions-today').textContent = '1,247';
            });
        }
        
        function updateTrendIndicator(elementId, value) {
            const element = document.getElementById(elementId);
            const isPositive = value > 0;
            const icon = isPositive ? 'fa-arrow-up' : 'fa-arrow-down';
            const color = isPositive ? 'text-green-600' : 'text-red-600';
            const sign = isPositive ? '+' : '';
            
            element.className = `text-sm font-medium ${color}`;
            element.innerHTML = `<i class="fas ${icon} mr-1"></i>${sign}${value}%`;
        }

        // Update charts with real data
        function updateCharts() {
            // Update accuracy chart with real data
            fetch(`/wintradesgo/api/trading/production.php?action=accuracy_trends&timeframe=${currentTimeframe}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const chartData = data.data;
                        accuracyChart.data.labels = chartData.map(d => d.timestamp);
                        accuracyChart.data.datasets[0].data = chartData.map(d => d.lstm);
                        accuracyChart.data.datasets[1].data = chartData.map(d => d.random_forest);
                        accuracyChart.data.datasets[2].data = chartData.map(d => d.svm);
                        accuracyChart.update();
                    }
                })
                .catch(error => {
                    console.error('Error loading accuracy trends:', error);
                    // Fallback to generated data
                    updateChartsWithFallbackData();
                });

            // Update confidence chart
            const modelFilter = document.getElementById('model-selector').value;
            fetch(`/wintradesgo/api/trading/production.php?action=confidence_distribution&model=${modelFilter}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const dist = data.distribution;
                        confidenceChart.data.datasets[0].data = [
                            dist.high_confidence,
                            dist.medium_confidence,
                            dist.low_confidence
                        ];
                        confidenceChart.update();
                    }
                })
                .catch(error => {
                    console.error('Error loading confidence distribution:', error);
                    confidenceChart.data.datasets[0].data = [65, 25, 10];
                    confidenceChart.update();
                });
        }
        
        function updateChartsWithFallbackData() {
            // Fallback data generation
            const labels = [];
            const now = new Date();
            for (let i = 23; i >= 0; i--) {
                const time = new Date(now.getTime() - i * 60 * 60 * 1000);
                labels.push(time.getHours() + ':00');
            }

            accuracyChart.data.labels = labels;
            accuracyChart.data.datasets[0].data = generateRandomData(24, 80, 95);
            accuracyChart.data.datasets[1].data = generateRandomData(24, 75, 90);
            accuracyChart.data.datasets[2].data = generateRandomData(24, 70, 85);
            accuracyChart.update();
        }

        // Update model comparison table
        function updateModelComparison() {
            fetch('/wintradesgo/api/trading/production.php?action=model_comparison')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const models = data.models;
                        const tbody = document.getElementById('model-comparison-table');
                        tbody.innerHTML = models.map(model => `
                            <tr class="border-b hover:bg-gray-50">
                                <td class="py-2 font-medium flex items-center">
                                    ${model.name}
                                    <span class="ml-2 px-2 py-1 text-xs rounded-full ${getStatusColor(model.status)}">
                                        ${model.status}
                                    </span>
                                </td>
                                <td class="text-center py-2">${model.accuracy}%</td>
                                <td class="text-center py-2">${model.precision}%</td>
                                <td class="text-center py-2">${model.recall}%</td>
                                <td class="text-center py-2">${model.f1_score}%</td>
                            </tr>
                        `).join('');
                    }
                })
                .catch(error => {
                    console.error('Error loading model comparison:', error);
                    // Fallback data
                    const models = [
                        { name: 'LSTM', accuracy: 87.3, precision: 85.1, recall: 89.2, f1_score: 87.1, status: 'active' },
                        { name: 'Random Forest', accuracy: 84.7, precision: 82.3, recall: 86.8, f1_score: 84.5, status: 'active' },
                        { name: 'SVM', accuracy: 81.2, precision: 79.8, recall: 83.1, f1_score: 81.4, status: 'training' }
                    ];

                    const tbody = document.getElementById('model-comparison-table');
                    tbody.innerHTML = models.map(model => `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-2 font-medium flex items-center">
                                ${model.name}
                                <span class="ml-2 px-2 py-1 text-xs rounded-full ${getStatusColor(model.status)}">
                                    ${model.status}
                                </span>
                            </td>
                            <td class="text-center py-2">${model.accuracy}%</td>
                            <td class="text-center py-2">${model.precision}%</td>
                            <td class="text-center py-2">${model.recall}%</td>
                            <td class="text-center py-2">${model.f1_score}%</td>
                        </tr>
                    `).join('');
                });
        }
        
        function getStatusColor(status) {
            switch(status) {
                case 'active': return 'bg-green-100 text-green-800';
                case 'training': return 'bg-yellow-100 text-yellow-800';
                case 'inactive': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Update ML alerts
        function updateAlerts() {
            const alerts = [
                { type: 'success', message: 'LSTM model achieved 92% accuracy on BTC predictions', time: '2 min ago' },
                { type: 'warning', message: 'Random Forest model accuracy dropped below 80%', time: '15 min ago' },
                { type: 'info', message: 'New training data available for model improvement', time: '1 hour ago' }
            ];

            const alertsContainer = document.getElementById('ml-alerts');
            alertsContainer.innerHTML = alerts.map(alert => `
                <div class="flex items-start space-x-3 p-3 border rounded-lg ${getAlertStyle(alert.type)}">
                    <i class="fas ${getAlertIcon(alert.type)} mt-1"></i>
                    <div class="flex-1">
                        <p class="text-sm font-medium">${alert.message}</p>
                        <p class="text-xs text-gray-500 mt-1">${alert.time}</p>
                    </div>
                </div>
            `).join('');
        }

        // Utility functions
        function generateRandomData(count, min, max) {
            return Array.from({length: count}, () => 
                Math.floor(Math.random() * (max - min + 1)) + min
            );
        }

        function getAlertStyle(type) {
            switch(type) {
                case 'success': return 'bg-green-50 border-green-200 text-green-800';
                case 'warning': return 'bg-yellow-50 border-yellow-200 text-yellow-800';
                case 'info': return 'bg-blue-50 border-blue-200 text-blue-800';
                default: return 'bg-gray-50 border-gray-200 text-gray-800';
            }
        }

        function getAlertIcon(type) {
            switch(type) {
                case 'success': return 'fa-check-circle text-green-600';
                case 'warning': return 'fa-exclamation-triangle text-yellow-600';
                case 'info': return 'fa-info-circle text-blue-600';
                default: return 'fa-bell text-gray-600';
            }
        }

        // Event handlers
        function setTimeframe(timeframe) {
            currentTimeframe = timeframe;
            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-primary', 'text-white');
                btn.classList.add('bg-gray-200');
            });
            event.target.classList.add('active', 'bg-primary', 'text-white');
            event.target.classList.remove('bg-gray-200');
            updateCharts();
        }

        function togglePredictionType() {
            predictionType = predictionType === 'price' ? 'direction' : 'price';
            document.getElementById('prediction-toggle').textContent = 
                predictionType === 'price' ? 'Price Predictions' : 'Direction Predictions';
            initPredictionVisualization();
        }

        function refreshAllData() {
            const refreshBtn = event.target;
            refreshBtn.innerHTML = '<i class="fas fa-sync-alt fa-spin mr-2"></i>Refreshing...';
            
            setTimeout(() => {
                loadInitialData();
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt mr-2"></i>Refresh';
            }, 2000);
        }

        function runBacktest() {
            const btn = event.target;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Running...';
            btn.disabled = true;
            
            setTimeout(() => {
                btn.innerHTML = '<i class="fas fa-play mr-2"></i>Run New Backtest';
                btn.disabled = false;
                // Update backtest results with new random values
                document.getElementById('backtest-return').textContent = '+' + (Math.random() * 30 + 10).toFixed(1) + '%';
                document.getElementById('sharpe-ratio').textContent = (Math.random() * 2 + 1).toFixed(2);
                document.getElementById('max-drawdown').textContent = '-' + (Math.random() * 15 + 5).toFixed(1) + '%';
                document.getElementById('win-rate').textContent = (Math.random() * 30 + 60).toFixed(1) + '%';
            }, 3000);
        }

        // Real-time updates
        function startRealTimeUpdates() {
            setInterval(() => {
                updateMetrics();
                updateCharts();
            }, 30000); // Update every 30 seconds
        }

        // Model selector change handler
        document.getElementById('model-selector').addEventListener('change', function() {
            updateCharts();
        });

        // Crypto selector change handler
        document.getElementById('crypto-selector').addEventListener('change', function() {
            initPredictionVisualization();
        });

        // Cryptocurrency selector change handler
        document.getElementById('main-crypto-selector').addEventListener('change', function() {
            const selectedCrypto = this.value;
            console.log(`Switching to ${selectedCrypto} analysis`);
            
            // Sync all crypto selectors
            const cryptoSelectors = document.querySelectorAll('[id*="crypto-selector"]');
            cryptoSelectors.forEach(selector => {
                if (selector.id !== 'main-crypto-selector') {
                    selector.value = selectedCrypto;
                }
            });
            
            // Update all components with new cryptocurrency data
            updateMetrics();
            updateCharts();
            updateModelComparison();
            initPredictionVisualization();
            initHeatmap();
            
            // Update page title and indicators
            updateCryptoIndicators(selectedCrypto);
        });

        // Sync secondary crypto selector with main selector
        document.getElementById('crypto-selector').addEventListener('change', function() {
            document.getElementById('main-crypto-selector').value = this.value;
            document.getElementById('main-crypto-selector').dispatchEvent(new Event('change'));
        });

        // Heatmap range change handler
        document.getElementById('heatmap-range').addEventListener('change', function() {
            initHeatmap();
        });
        
        // Timeframe selector change handler
        document.getElementById('timeframe-selector').addEventListener('change', function() {
            currentTimeframe = this.value;
            updateCharts();
        });
        
        // Model filter change handler
        document.getElementById('model-filter').addEventListener('change', function() {
            const selectedModel = this.value;
            filterModelData(selectedModel);
        });
        
        // Confidence threshold change handler
        document.getElementById('confidence-threshold').addEventListener('change', function() {
            const threshold = parseFloat(this.value);
            filterByConfidence(threshold);
            document.getElementById('confidence-value').textContent = threshold + '%';
        });
        
        // Advanced filtering functions
        function updateCryptoIndicators(crypto) {
            // Update crypto-specific indicators and styling
            const cryptoColors = {
                'BTC': '#f7931a',
                'ETH': '#627eea',
                'ADA': '#0033ad',
                'SOL': '#66f9ef',
                'DOT': '#e6007a'
            };
            
            const color = cryptoColors[crypto] || '#3b82f6';
            
            // Update accent colors throughout the dashboard
            document.documentElement.style.setProperty('--crypto-accent', color);
            
            // Update navigation breadcrumb
            const breadcrumb = document.querySelector('.crypto-breadcrumb');
            if (breadcrumb) {
                breadcrumb.textContent = `ML Analytics > ${crypto} Analysis`;
            }
        }
        
        function filterModelData(modelType) {
            if (modelType === 'all') {
                // Show all models
                showAllModels();
            } else {
                // Filter by specific model type
                highlightModel(modelType);
            }
        }
        
        function filterByConfidence(threshold) {
            // Filter predictions by confidence threshold
            const currentData = getPredictionData();
            const filteredData = currentData.filter(prediction => 
                prediction.confidence >= threshold
            );
            
            // Update visualizations with filtered data
            updateVisualizationsWithFilter(filteredData);
        }
        
        function showAllModels() {
            // Reset all model visibility
            const modelElements = document.querySelectorAll('.model-data');
            modelElements.forEach(element => {
                element.style.opacity = '1';
                element.style.display = 'block';
            });
        }
        
        function highlightModel(modelType) {
            // Highlight specific model in charts and tables
            const modelElements = document.querySelectorAll('.model-data');
            modelElements.forEach(element => {
                if (element.dataset.model === modelType) {
                    element.style.opacity = '1';
                    element.style.fontWeight = 'bold';
                } else {
                    element.style.opacity = '0.5';
                    element.style.fontWeight = 'normal';
                }
            });
        }
        
        function getPredictionData() {
            // Return current prediction data (would normally come from API)
            return window.currentPredictionData || [];
        }
        
        function updateVisualizationsWithFilter(filteredData) {
            // Update 3D visualization with filtered data
            if (filteredData.length > 0) {
                createAdvanced3DVisualization(filteredData);
            }
            
            // Update metrics to reflect filtered data
            const avgConfidence = filteredData.reduce((sum, p) => sum + p.confidence, 0) / filteredData.length;
            const accuracySum = filteredData.reduce((sum, p) => sum + p.accuracy, 0) / filteredData.length;
            
            // Update confidence indicator
            const confidenceElement = document.getElementById('avg-confidence');
            if (confidenceElement) {
                confidenceElement.textContent = avgConfidence.toFixed(1) + '%';
            }
        }

        // Auto-refresh functionality
        function startAutoRefresh() {
            // Refresh data every 30 seconds
            setInterval(() => {
                if (document.visibilityState === 'visible') {
                    refreshAllData();
                }
            }, 30000);
        }
        
        function refreshAllData() {
            updateMetrics();
            updateCharts();
            updateModelComparison();
            
            // Only refresh heavy visualizations every 2 minutes
            if (Date.now() % 120000 < 30000) {
                initPredictionVisualization();
                initHeatmap();
            }
            
            // Show refresh indicator
            showRefreshIndicator();
        }
        
        function showRefreshIndicator() {
            const indicator = document.createElement('div');
            indicator.className = 'fixed top-4 right-4 bg-green-500 text-white px-3 py-1 rounded text-sm z-50';
            indicator.textContent = 'Data updated';
            document.body.appendChild(indicator);
            
            setTimeout(() => {
                indicator.remove();
            }, 2000);
        }
    </script>
</body>
</html>